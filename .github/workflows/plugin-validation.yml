name: Enhanced Plugin Validation

on:
    push:
        branches: [main, develop]
        paths:
            - ".claude-plugin/**"
            - "plugins/**"
            - ".github/workflows/plugin-validation.yml"
    pull_request:
        branches: [main]
        paths:
            - ".claude-plugin/**"
            - "plugins/**"
    workflow_dispatch:

jobs:
    # å‡†å¤‡æ­¥éª¤ï¼šè¯»å–æ’ä»¶åˆ—è¡¨
    prepare:
        name: Discover Plugins
        runs-on: ubuntu-latest
        outputs:
            plugins: ${{ steps.discover.outputs.plugins }}
            plugin_count: ${{ steps.discover.outputs.plugin_count }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Discover plugins from marketplace.json
              id: discover
              run: |
                # è¯»å– marketplace.json å¹¶æå–æ’ä»¶åç§°åˆ—è¡¨
                if [ -f ".claude-plugin/marketplace.json" ]; then
                  # ä½¿ç”¨ jq æå–æ’ä»¶åç§°ï¼Œè½¬æ¢ä¸º JSON æ•°ç»„
                  plugins=$(jq -r '[.plugins[].name] | @json' .claude-plugin/marketplace.json)
                  plugin_count=$(jq '[.plugins[].name] | length' .claude-plugin/marketplace.json)

                  echo "Discovered $plugin_count plugins"
                  echo "plugins=$plugins" >> $GITHUB_OUTPUT
                  echo "plugin_count=$plugin_count" >> $GITHUB_OUTPUT
                else
                  echo "âŒ marketplace.json not found"
                  echo "plugins=[]"
                  exit 1
                fi

    validate:
        name: Validate ${{ matrix.plugin }}
        runs-on: ubuntu-latest
        needs: prepare

        strategy:
            fail-fast: false
            matrix:
                plugin: ${{ fromJson(needs.prepare.outputs.plugins) }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y jq

            - name: Validate marketplace.json
              id: marketplace-validation
              run: |
                  echo "ðŸ” Validating marketplace.json..."

                  if [ -f ".claude-plugin/marketplace.json" ]; then
                    if jq empty .claude-plugin/marketplace.json; then
                      echo "âœ… marketplace.json is valid JSON"

                      # æ£€æŸ¥åŸºæœ¬ç»“æž„
                      if jq -e '.name' .claude-plugin/marketplace.json > /dev/null && \
                         jq -e '.plugins' .claude-plugin/marketplace.json > /dev/null; then
                        echo "âœ… marketplace.json has required fields"
                        echo "marketplace_valid=true" >> $GITHUB_OUTPUT
                      else
                        echo "âŒ marketplace.json missing required fields"
                        echo "marketplace_valid=false" >> $GITHUB_OUTPUT
                        exit 1
                      fi
                    else
                      echo "âŒ marketplace.json is invalid JSON"
                      echo "marketplace_valid=false" >> $GITHUB_OUTPUT
                      exit 1
                    fi
                  else
                    echo "âŒ marketplace.json not found"
                    echo "marketplace_valid=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: Validate Plugin Structure
              id: structure-validation
              run: |
                  echo "ðŸ” Validating plugin structure: ${{ matrix.plugin }}..."

                  plugin_dir="plugins/${{ matrix.plugin }}"

                  if [ -d "$plugin_dir" ]; then
                    echo "âœ… Plugin directory exists: $plugin_dir"

                    # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
                    required_files=("README.md")
                    required_dirs=("agents" "skills" "commands")

                    all_valid=true

                    for file in "${required_files[@]}"; do
                      if [ -f "$plugin_dir/$file" ]; then
                        echo "âœ… Required file exists: $file"
                      else
                        echo "âŒ Required file missing: $file"
                        all_valid=false
                      fi
                    done

                    for dir in "${required_dirs[@]}"; do
                      if [ -d "$plugin_dir/$dir" ]; then
                        echo "âœ… Required directory exists: $dir"
                        if [ "$(ls -A $plugin_dir/$dir)" ]; then
                          echo "âœ… Directory $dir is not empty"
                        else
                          echo "âŒ Directory $dir is empty"
                          all_valid=false
                        fi
                      else
                        echo "âŒ Required directory missing: $dir"
                        all_valid=false
                      fi
                    done

                    # æ£€æŸ¥å¯é€‰ç›®å½•
                    optional_dirs=("templates" "tools")
                    for dir in "${optional_dirs[@]}"; do
                      if [ -d "$plugin_dir/$dir" ]; then
                        echo "âœ… Optional directory exists: $dir"
                      fi
                    done

                    if [ "$all_valid" = true ]; then
                      echo "âœ… Plugin structure validation passed"
                      echo "structure_valid=true" >> $GITHUB_OUTPUT
                    else
                      echo "âŒ Plugin structure validation failed"
                      echo "structure_valid=false" >> $GITHUB_OUTPUT
                      exit 1
                    fi
                  else
                    echo "âŒ Plugin directory not found: $plugin_dir"
                    echo "structure_valid=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: Run Validation Scripts
              id: script-validation
              run: |
                  echo "ðŸ” Running comprehensive validation scripts..."

                  # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
                  chmod +x .github/scripts/*.py 2>/dev/null || true

                  # è¿è¡Œå¼•ç”¨æ£€æŸ¥ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  if [ -f ".github/scripts/check_references.py" ]; then
                    echo "Running file reference check..."
                    if python3 .github/scripts/check_references.py; then
                      echo "âœ… File reference check passed"
                      references_valid=true
                    else
                      echo "âŒ File reference check failed"
                      references_valid=false
                    fi
                  else
                    echo "â­ï¸ Skipping file reference check (script not found)"
                    references_valid=true
                  fi

                  # è¿è¡ŒMCPä¾èµ–æ£€æŸ¥ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  if [ -f ".github/scripts/check_mcp_dependencies.py" ]; then
                    echo "Running MCP dependency check..."
                    if python3 .github/scripts/check_mcp_dependencies.py; then
                      echo "âœ… MCP dependency check passed"
                      mcp_valid=true
                    else
                      echo "âŒ MCP dependency check failed"
                      mcp_valid=false
                    fi
                  else
                    echo "â­ï¸ Skipping MCP dependency check (script not found)"
                    mcp_valid=true
                  fi

                  # è¿è¡Œå†…å®¹è´¨é‡æ£€æŸ¥ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  if [ -f ".github/scripts/validate_content.py" ]; then
                    echo "Running content quality check..."
                    if python3 .github/scripts/validate_content.py plugins/${{ matrix.plugin }}; then
                      echo "âœ… Content quality check passed"
                    else
                      echo "âš ï¸ Content quality check found issues (non-blocking)"
                    fi
                  else
                    echo "â­ï¸ Skipping content quality check (script not found)"
                  fi

                  if [ "$references_valid" = true ] && [ "$mcp_valid" = true ]; then
                    echo "âœ… All script validations passed"
                    echo "scripts_valid=true" >> $GITHUB_OUTPUT
                  else
                    echo "âŒ Script validations failed"
                    echo "scripts_valid=false" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: Generate Validation Report
              if: always()
              run: |
                  echo "# ðŸ“Š Plugin Validation Report for ${{ matrix.plugin }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ“‹ Marketplace: ${{ steps.marketplace-validation.outputs.marketplace_valid }}" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ—ï¸ Structure: ${{ steps.structure-validation.outputs.structure_valid }}" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ”— Scripts: ${{ steps.script-validation.outputs.scripts_valid }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ steps.marketplace-validation.outputs.marketplace_valid }}" == "true" &&
                        "${{ steps.structure-validation.outputs.structure_valid }}" == "true" &&
                        "${{ steps.script-validation.outputs.scripts_valid }}" == "true" ]]; then
                    echo "## âœ… Validation Status: PASSED" >> $GITHUB_STEP_SUMMARY
                    echo "Plugin ${{ matrix.plugin }} has passed all validation checks successfully." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "## âŒ Validation Status: FAILED" >> $GITHUB_STEP_SUMMARY
                    echo "Plugin ${{ matrix.plugin }} has failed one or more validation checks." >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi

    integration-validation:
        name: Integration Validation
        runs-on: ubuntu-latest
        needs: [prepare, validate]
        if: success()

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y jq

            - name: Run Complete Validation Suite
              run: |
                  echo "ðŸ” Running complete validation suite..."
                  echo "Plugin count: ${{ needs.prepare.outputs.plugin_count }}"

                  # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
                  chmod +x .github/scripts/*.py 2>/dev/null || true

                  # è¿è¡Œæ‰€æœ‰éªŒè¯è„šæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  if [ -f ".github/scripts/check_references.py" ]; then
                    echo "Running file reference check..."
                    python3 .github/scripts/check_references.py
                  fi

                  if [ -f ".github/scripts/check_mcp_dependencies.py" ]; then
                    echo "Running MCP dependency check..."
                    python3 .github/scripts/check_mcp_dependencies.py
                  fi

                  echo "âœ… All validation checks completed successfully!"

            - name: Generate Final Summary
              run: |
                  echo "# ðŸ Complete Validation Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## Workflow Status: âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Validated Plugins" >> $GITHUB_STEP_SUMMARY
                  echo "- Total Plugins: ${{ needs.prepare.outputs.plugin_count }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Job Results" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ“Š Individual Validation: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ”— Integration Validation: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ðŸŽ‰ All validations passed! Plugin collection is ready for deployment." >> $GITHUB_STEP_SUMMARY
