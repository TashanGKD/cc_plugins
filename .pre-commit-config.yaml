# Pre-commit hooks configuration for Claude Code Plugins
# See https://pre-commit.com for more information
# Usage: pip install pre-commit && pre-commit install

default_language_version:
  python: python3

repos:
  # 提交信息规范检查
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v3.2.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        types: [text]
        args: ["feat, fix, docs, style, refactor, test, chore"]

  # 本地 hooks
  - repo: local
    hooks:
      # 验证 marketplace.json
      - id: validate-marketplace
        name: Validate marketplace.json
        entry: bash -c 'if ! command -v claude &> /dev/null; then echo "❌ Claude CLI 未安装" && exit 1; fi; if ! claude plugin validate .claude-plugin/marketplace.json; then echo "❌ marketplace.json 验证失败" && exit 1; fi; echo "✅ marketplace.json 验证通过"'
        language: system
        files: 'marketplace\.json$'
        pass_filenames: false

      # 验证各个插件的 plugin.json 格式
      - id: validate-plugin-json
        name: Validate plugin.json format
        entry: >-
          bash -c '
          file="$1";
          echo "验证 $file";

          author_type=$(jq -r ".author | type" "$file" 2>/dev/null || echo "null");
          if [ "$author_type" != "object" ]; then
            echo "❌ author 必须是对象类型 {\"name\": \"...\", \"email\": \"...\"}";
            exit 1;
          fi;

          author_name=$(jq -r ".author.name" "$file" 2>/dev/null || echo "");
          if [ "$author_name" = "" ] || [ "$author_name" = "null" ]; then
            echo "❌ author.name 不能为空";
            exit 1;
          fi;

          if jq -e ".category" "$file" >/dev/null 2>&1; then
            echo "❌ 不应有 category 字段";
            exit 1;
          fi;

          if jq -e ".entry_points" "$file" >/dev/null 2>&1; then
            echo "❌ 不应有 entry_points 字段，应直接使用 agents/skills/commands";
            exit 1;
          fi;

          echo "✅ $file 格式正确";
          ' bash
        language: system
        files: '^plugins/[^/]*/plugin\.json$'

      # 自动更新 README 表格
      - id: update-readme-tables
        name: Update README tables
        entry: bash -c 'python scripts/generate_readme_tables.py && git add README.md'
        language: system
        files: '(\.claude-plugin/marketplace\.json|\.claude/commands/.*\.md|plugins/[^/]*/commands/.*\.md)'
        pass_filenames: false

  # 通用检查
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # 检查 JSON 格式
      - id: check-json
        files: '(\\.claude-plugin/.*\\.json|plugins/.*/\\.mcp\\.json|plugins/.*/plugin\\.json)'
      # 检查 YAML 格式
      - id: check-yaml
      # 检查大文件
      - id: check-added-large-files
        args: ['--maxkb=100']
      # 检查行尾空白
      - id: trailing-whitespace
      # 检查结尾换行
      - id: end-of-file-fixer
